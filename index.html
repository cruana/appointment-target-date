<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health Scheduler</title>
    <style>
        :root { --primary: #0070e0; --bg: #f4f7f6; --card: #ffffff; --text: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); padding: 20px; display: flex; justify-content: center; }
        
        .card { background: var(--card); width: 100%; max-width: 600px; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { margin-top: 0; color: var(--primary); text-align: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 25px; }
        
        label { display: block; margin-top: 15px; font-weight: 600; font-size: 0.95em; color: #555; }
        select, input { width: 100%; padding: 12px; margin-top: 6px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background-color: #fafafa; transition: border 0.2s; box-sizing: border-box;}
        select:focus, input:focus { border-color: var(--primary); outline: none; background-color: #fff; }
        
        button { width: 100%; margin-top: 25px; padding: 14px; background-color: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        button:hover { background-color: #0056b3; }
        
        .alert-box { padding: 15px; border-radius: 8px; margin-top: 20px; display: none; }
        .alert-crisis { background-color: #ffebee; border-left: 6px solid #d32f2f; color: #c62828; }
        .alert-warning { background-color: #fff3cd; border-left: 6px solid #ffc107; color: #856404; }
        .result-section { background-color: #e8f4fd; border-left: 6px solid var(--primary); padding: 20px; border-radius: 8px; margin-top: 25px; display: none; }
        
        .hidden { display: none !important; }
        .helper-text { font-size: 0.85em; color: #777; margin-top: 4px; font-style: italic; }
        
        .status-pass { color: #2e7d32; font-weight: bold; font-size: 1.2em; }
        .status-fail { color: #c62828; font-weight: bold; font-size: 1.2em; }
    </style>
</head>
<body>

<div class="card">
    <h2>Mental Health Target Calculator</h2>

    <label for="callType">1. Select Scenario:</label>
    <select id="callType" onchange="handleScenarioChange()">
        <option value="" disabled selected>-- Choose One --</option>
        <option value="new">New Appointment Request</option>
        <option value="cancel">Cancellation / Reschedule</option>
        <option value="crisis">üö® CRISIS / Safety Concern</option>
    </select>

    <div id="crisisAlert" class="alert-box alert-crisis">
        <h3>üõë STOP: DO NOT BOOK</h3>
        <p><strong>Protocol:</strong> Immediate Warm Transfer to OD Pool or Access & Crisis Line.</p>
        <p><em>Criteria: Suicidal/Homicidal risk, hallucinations, domestic violence < 48hrs.</em></p>
    </div>

    <div id="poshCancelAlert" class="alert-box alert-warning">
        <h3>‚ö†Ô∏è Transfer Required</h3>
        <p>Call Center cannot reschedule POSH. Please <strong>Warm Transfer</strong> to the clinic Back Office.</p>
    </div>

    <div id="mainInputs" class="hidden">
        <label for="apptType">2. Appointment Category:</label>
        <select id="apptType" onchange="updateLabels()">
            <option value="therapy">Intake / FIC Therapy</option>
            <option value="consult">MD Consult / Intake</option>
            <option value="followup">Follow-Up</option>
            <option value="routine">MD Routine</option>
            <option value="posh">POSH (Hospital Discharge)</option>
            <option value="urgent">Urgent</option>
        </select>
        <div id="ruleText" class="helper-text">Standard: 14 Calendar or 10 Business days</div>

        <label id="dateLabel" for="startDate">3. Referral / Contact Date:</label>
        <input type="date" id="startDate">

        <button onclick="calculateTarget()">Calculate Target Date</button>
    </div>

    <div id="resultArea" class="result-section">
        <div><strong>Target Due Date:</strong> <span id="targetDateDisplay" style="font-size: 1.3em;"></span></div>
        <div id="calcMethod" class="helper-text" style="margin-bottom: 10px;"></div>
        <hr style="border: 0; border-top: 1px solid #cfe2f3; margin: 15px 0;">
        
        <label>4. Compliance Check:</label>
        <div style="margin-bottom:10px;">
            <input type="checkbox" id="epnCheck" onchange="checkCompliance()" style="width:auto;"> 
            <span style="font-weight:bold; color:#0070e0;">Was EPN / Rula / Lucet offered?</span>
        </div>

        <label>First Offered Appointment Date:</label>
        <input type="date" id="offeredDate" onchange="checkCompliance()">

        <div style="margin-top: 20px; text-align: center;">
            <div id="finalStatus" class="status-fail">PENDING INPUT</div>
            <div id="actionItem" class="helper-text"></div>
        </div>
    </div>
</div>

<script>
    // --- RULES CONFIGURATION ---
    const RULES = {
        "therapy":  { cal: 14, bus: 10, note: "14 Calendar / 10 Business Days" },
        "consult":  { cal: 14, bus: 10, note: "14 Calendar / 10 Business Days" },
        "followup": { cal: 7,  bus: 5,  note: "7 Calendar / 5 Business Days" },
        "routine":  { cal: 0,  bus: 15, note: "15 Business Days" },
        "posh":     { cal: 3,  bus: 0,  note: "3 Calendar Days from Discharge" },
        "urgent":   { cal: 1,  bus: 0,  note: "1 Calendar Day" }
    };

    let calculatedTargetDate = null;

    // --- VIEW CONTROLLER ---
    function handleScenarioChange() {
        const scenario = document.getElementById("callType").value;
        const apptType = document.getElementById("apptType").value;
        
        // 1. Hide everything first (Clean Slate)
        document.getElementById("crisisAlert").style.display = "none";
        document.getElementById("poshCancelAlert").style.display = "none";
        document.getElementById("mainInputs").classList.add("hidden");
        document.getElementById("resultArea").style.display = "none";

        // 2. Show relevant section
        if (scenario === "crisis") {
            document.getElementById("crisisAlert").style.display = "block";
        } else if (scenario === "cancel" && apptType === "posh") {
            // Guardrail: Cannot reschedule POSH
            document.getElementById("poshCancelAlert").style.display = "block";
        } else {
            // Show Calculator
            document.getElementById("mainInputs").classList.remove("hidden");
            updateLabels();
        }
    }

    function updateLabels() {
        const type = document.getElementById("apptType").value;
        const scenario = document.getElementById("callType").value;
        
        // Re-check POSH guardrail in case user changed dropdown while in Cancel mode
        if (scenario === "cancel" && type === "posh") {
            handleScenarioChange(); 
            return;
        }

        // Update Text
        if (scenario === "cancel") {
            document.getElementById("ruleText").textContent = "Reschedule: 10 Business Days (approx 14 Calendar)";
            document.getElementById("dateLabel").textContent = "Original Target / Referral Date:";
        } else {
            document.getElementById("ruleText").textContent = RULES[type].note;
            document.getElementById("dateLabel").textContent = (type === "posh") ? "Hospital Discharge Date:" : "Referral / Contact Date:";
        }
    }

    // --- DATE HELPERS ---
    function addBusinessDays(date, days) {
        let result = new Date(date);
        let added = 0;
        while (added < days) {
            result.setDate(result.getDate() + 1);
            if (result.getDay() !== 0 && result.getDay() !== 6) {
                added++;
            }
        }
        return result;
    }

    function addCalendarDays(date, days) {
        let result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    }

    // --- MAIN CALCULATION ---
    function calculateTarget() {
        const startStr = document.getElementById("startDate").value;
        const type = document.getElementById("apptType").value;
        const scenario = document.getElementById("callType").value;

        if (!startStr) { alert("Please select a date first."); return; }

        // Create Date Object (Fixing Timezone Issue)
        const parts = startStr.split('-');
        const startDate = new Date(parts[0], parts[1] - 1, parts[2]);
        
        // SAFETY CHECK: Future Date Warning
        const today = new Date();
        today.setHours(0,0,0,0);
        if (startDate > today && type !== "posh") {
            const confirmFuture = confirm("‚ö†Ô∏è WARNING: You selected a future date.\n\nIs this correct? (Usually 'Contact Date' is today or in the past).");
            if (!confirmFuture) return; 
        }

        const rule = RULES[type];
        let methodText = "";

        if (scenario === "cancel") {
            // Cancellation Logic: 10 Business Days
            calculatedTargetDate = addBusinessDays(startDate, 10);
            methodText = "Calculated based on 10 Business Days from Original Target";
        } else {
            // Standard Logic
            if (rule.bus > 0) {
                calculatedTargetDate = addBusinessDays(startDate, rule.bus);
                methodText = "Calculated based on " + rule.bus + " Business Days";
            } else {
                calculatedTargetDate = addCalendarDays(startDate, rule.cal);
                methodText = "Calculated based on " + rule.cal + " Calendar Days";
            }
        }

        // Display Result
        const options = { weekday: 'short', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById("targetDateDisplay").textContent = calculatedTargetDate.toLocaleDateString('en-US', options);
        document.getElementById("calcMethod").textContent = methodText;
        document.getElementById("resultArea").style.display = "block";
        
        // Reset Compliance
        document.getElementById("finalStatus").textContent = "PENDING INPUT";
        document.getElementById("finalStatus").className = "status-fail"; 
        document.getElementById("actionItem").textContent = "Enter an offered date or select EPN to verify compliance.";
        
        checkCompliance();
    }

    function checkCompliance() {
        const offeredStr = document.getElementById("offeredDate").value;
        const isEpn = document.getElementById("epnCheck").checked;
        const statusEl = document.getElementById("finalStatus");
        const actionEl = document.getElementById("actionItem");

        if (isEpn) {
            statusEl.textContent = "‚úÖ COMPLIANT (EPN Offered)";
            statusEl.className = "status-pass";
            actionEl.textContent = "Offering external network (Rula/Lucet) satisfies access standards.";
            return;
        }

        if (offeredStr && calculatedTargetDate) {
            const parts = offeredStr.split('-');
            const offeredDate = new Date(parts[0], parts[1] - 1, parts[2]);

            if (offeredDate <= calculatedTargetDate) {
                statusEl.textContent = "‚úÖ COMPLIANT (Target Met)";
                statusEl.className = "status-pass";
                actionEl.textContent = "Great job! The offered date is within the required timeframe.";
            } else {
                statusEl.textContent = "‚ö†Ô∏è OUT OF TARGET";
                statusEl.className = "status-fail";
                actionEl.textContent = "If member declined earlier dates, mark as 'Member Declined'. If no appointments available, send SB-855 letter.";
            }
        }
    }
</script>

</body>
</html>
