<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health Scheduler</title>
    <style>
        :root { --primary: #0070e0; --bg: #f4f7f6; --card: #ffffff; --text: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); padding: 20px; display: flex; justify-content: center; }
        
        .card { background: var(--card); width: 100%; max-width: 650px; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        /* HEADER */
        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; margin-bottom: 25px; padding-bottom: 10px; }
        h2 { margin: 0; color: var(--primary); font-size: 1.5em; }
        .reset-btn { background-color: #f1f3f4; color: #333; border: 1px solid #dadce0; padding: 8px 16px; border-radius: 6px; font-size: 0.9em; cursor: pointer; transition: all 0.2s; font-weight: 600; }
        .reset-btn:hover { background-color: #e8eaed; border-color: #333; }

        label { display: block; margin-top: 15px; font-weight: 600; font-size: 0.95em; color: #555; }
        select, input { width: 100%; padding: 12px; margin-top: 6px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background-color: #fafafa; transition: border 0.2s; box-sizing: border-box;}
        select:focus, input:focus { border-color: var(--primary); outline: none; background-color: #fff; }
        
        /* Clickable Date Inputs */
        input[type="date"] { cursor: pointer; } 

        .action-btn { width: 100%; margin-top: 25px; padding: 14px; background-color: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .action-btn:hover { background-color: #0056b3; }
        
        /* ALERTS & SECTIONS */
        .alert-box { padding: 15px; border-radius: 8px; margin-top: 20px; display: none; }
        .alert-crisis { background-color: #ffebee; border-left: 6px solid #d32f2f; color: #c62828; }
        .alert-warning { background-color: #fff3cd; border-left: 6px solid #ffc107; color: #856404; }
        
        .result-section { background-color: #e8f4fd; border-left: 6px solid var(--primary); padding: 20px; border-radius: 8px; margin-top: 25px; display: none; }
        
        .hidden { display: none !important; }
        .helper-text { font-size: 0.85em; color: #777; margin-top: 4px; font-style: italic; }
        
        /* STATUS FLAGS */
        .status-pass { color: #2e7d32; font-weight: bold; font-size: 1.2em; }
        .status-fail { color: #c62828; font-weight: bold; font-size: 1.2em; }
        .status-warn { color: #e67e22; font-weight: bold; font-size: 1.2em; } 
        
        .escalation-flag { color: #d32f2f; font-weight: bold; margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #d32f2f; border-radius: 4px; }
        .info-note { color: #0070e0; font-weight: bold; font-size: 0.9em; margin-top: 5px; display: block; }
        .date-warning { color: #d35400; font-weight: bold; font-size: 0.9em; margin-top: 5px; display: block; }

        /* POOL INFO BOX */
        .pool-box { margin-top: 15px; padding: 12px; background-color: #fff; border: 1px solid #cfe2f3; border-radius: 6px; font-size: 0.95em; }
        .pool-label { font-weight: bold; color: #555; }
        .pool-number { font-family: monospace; font-size: 1.1em; color: #333; background: #eee; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
    </style>
</head>
<body>

<div class="card">
    <div class="header-row">
        <h2>Mental Health Scheduler</h2>
        <button onclick="resetForm()" class="reset-btn">üîÑ New Entry</button>
    </div>

    <label for="callType">1. Select Scenario:</label>
    <select id="callType" onchange="handleScenarioChange()">
        <option value="" disabled selected>-- Choose One --</option>
        <option value="new">New Appointment Request</option>
        <option value="cancel">Cancellation / Reschedule</option>
        <option value="crisis">üö® CRISIS / Safety Concern</option>
    </select>

    <div id="crisisAlert" class="alert-box alert-crisis">
        <h3>üõë STOP: DO NOT BOOK</h3>
        <p><strong>Protocol:</strong> Immediate Warm Transfer to OD Pool or Access & Crisis Line.</p>
        <p><em>Criteria: Suicidal/Homicidal risk, hallucinations, domestic violence < 48hrs.</em></p>
    </div>

    <div id="poshCancelAlert" class="alert-box alert-warning">
        <h3>‚ö†Ô∏è Transfer Required</h3>
        <p>Call Center cannot reschedule POSH. Please <strong>Warm Transfer</strong> to the clinic Back Office.</p>
    </div>

    <div id="mainInputs" class="hidden">
        <label for="homeClinic">2. Patient's Home Clinic:</label>
        <select id="homeClinic" onchange="updatePoolInfo()">
            <option value="" disabled selected>-- Select Clinic --</option>
            <option value="vista">Vista (VIS)</option>
            <option value="rb">Rancho Bernardo (RB)</option>
            <option value="plo">Point Loma (PLO)</option>
            <option value="bos">Bostonia (BOS)</option>
            <option value="otm">Otay Mesa (OTM)</option>
        </select>

        <label for="apptType">3. Appointment Category:</label>
        <select id="apptType" onchange="updateLabels()">
            <option value="therapy">Intake / FIC Therapy</option>
            <option value="consult">MD Consult / Intake</option>
            <option value="followup">Follow-Up</option>
            <option value="routine">MD Routine</option>
            <option value="posh">POSH (Hospital Discharge)</option>
            <option value="urgent">Urgent</option>
        </select>
        <div id="ruleText" class="helper-text">Standard: 14 Calendar or 10 Business days</div>

        <label id="dateLabel" for="startDate">4. Referral / Contact Date:</label>
        <input type="date" id="startDate" onclick="try{this.showPicker()}catch(e){}">

        <button onclick="calculateTarget()" class="action-btn">Calculate Target Date</button>
    </div>

    <div id="resultArea" class="result-section">
        <div><strong>Target Due Date:</strong> <span id="targetDateDisplay" style="font-size: 1.3em;"></span></div>
        <div id="calcMethod" class="helper-text" style="margin-bottom: 5px;"></div>
        <div id="resetNote" class="info-note hidden"></div>
        
        <hr style="border: 0; border-top: 1px solid #cfe2f3; margin: 15px 0;">
        
        <label>5. First Offered Appointment Date (Internal):</label>
        <input type="date" id="offeredDate" onchange="revealStep4b()" onclick="try{this.showPicker()}catch(e){}">

        <div id="step4b_container" class="hidden">
            <label>Reason for Date (If Late):</label>
            <select id="outcomeReason" onchange="checkCompliance()">
                <option value="met">Date is within Target</option>
                <option value="patient_declined">Member Declined Earlier Dates (Access Met)</option>
                <option value="provider_unavailable">No Appointments Available (Access Missed)</option>
            </select>
        </div>

        <div id="step5_container" class="hidden">
            <label>6. EPN / In-Network Providers:</label>
            <select id="epnStatus" onchange="checkCompliance()">
                <option value="" disabled selected>-- Select Status --</option>
                <option value="none">Not Offered / Not Applicable</option>
                <option value="accepted">Offered & ACCEPTED</option>
                <option value="declined">Offered & DECLINED</option>
            </select>
            <div class="helper-text">Rula, Lucet, or other In-Network partners.</div>
        </div>

        <div style="margin-top: 20px; text-align: center;">
            <div id="finalStatus" class="status-fail">PENDING INPUT</div>
            <div id="dateWarning" class="date-warning hidden"></div>
            
            <div id="escalationWarning" class="escalation-flag hidden">
                ‚ö†Ô∏è ESCALATION PROTOCOL REQUIRED
                <div style="font-weight: normal; margin-top:5px; font-size: 0.9em;">Conduct Warm Hand-off to Local Admin</div>
            </div>
            
            <div id="actionItem" class="helper-text"></div>

            <div id="poolDisplay" class="pool-box hidden">
                <div style="margin-bottom: 4px;">üìç <span id="poolClinicName"></span> Routing:</div>
                <div><span class="pool-label">Escalation (Mgr/ADA):</span> <span id="poolMgr" class="pool-number"></span></div>
                <div><span class="pool-label">Waitlist/Clerk:</span> <span id="poolClerk" class="pool-number"></span></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- DATA: RULES & POOLS ---
    const RULES = {
        "therapy":  { cal: 14, bus: 10, note: "14 Calendar / 10 Business Days" },
        "consult":  { cal: 14, bus: 10, note: "14 Calendar / 10 Business Days" },
        "followup": { cal: 7,  bus: 5,  note: "7 Calendar / 5 Business Days" },
        "routine":  { cal: 0,  bus: 15, note: "15 Business Days" },
        "posh":     { cal: 3,  bus: 0,  note: "3 Calendar Days from Discharge" },
        "urgent":   { cal: 1,  bus: 0,  note: "1 Calendar Day" }
    };

    // POOL DATA sourced from PDF Pages 63 & 31
    const POOLS = {
        "vista": { name: "Vista", mgr: "124531", clerk: "10210" },
        "rb":    { name: "Rancho Bernardo", mgr: "124535", clerk: "18574" },
        "plo":   { name: "Point Loma", mgr: "124536", clerk: "10241" },
        "bos":   { name: "Bostonia", mgr: "124532", clerk: "10629" },
        "otm":   { name: "Otay Mesa", mgr: "124528", clerk: "10427" }
    };

    let calculatedTargetDate = null;

    // --- RESET FUNCTION ---
    function resetForm() {
        document.getElementById("callType").selectedIndex = 0;
        document.getElementById("homeClinic").selectedIndex = 0;
        document.getElementById("apptType").selectedIndex = 0;
        document.getElementById("startDate").value = "";
        
        document.getElementById("offeredDate").value = "";
        document.getElementById("outcomeReason").selectedIndex = 0;
        document.getElementById("epnStatus").selectedIndex = 0;

        calculatedTargetDate = null;
        handleScenarioChange();
        
        document.getElementById("resultArea").style.display = "none";
        document.getElementById("step4b_container").classList.add("hidden");
        document.getElementById("step5_container").classList.add("hidden");
        document.getElementById("poolDisplay").classList.add("hidden");
        
        document.getElementById("resetNote").classList.add("hidden");
        document.getElementById("finalStatus").textContent = "PENDING INPUT";
        document.getElementById("finalStatus").className = "status-fail";
    }

    function handleScenarioChange() {
        const scenario = document.getElementById("callType").value;
        const apptType = document.getElementById("apptType").value;
        
        document.getElementById("crisisAlert").style.display = "none";
        document.getElementById("poshCancelAlert").style.display = "none";
        document.getElementById("mainInputs").classList.add("hidden");
        document.getElementById("resultArea").style.display = "none";

        if (scenario === "crisis") {
            document.getElementById("crisisAlert").style.display = "block";
        } else if (scenario === "cancel" && apptType === "posh") {
            document.getElementById("poshCancelAlert").style.display = "block";
        } else if (scenario) {
            document.getElementById("mainInputs").classList.remove("hidden");
            updateLabels();
        }
    }

    function updateLabels() {
        const type = document.getElementById("apptType").value;
        const scenario = document.getElementById("callType").value;
        
        if (scenario === "cancel") {
            document.getElementById("ruleText").textContent = "Reschedule: 10 Business Days (approx 14 Calendar)";
            document.getElementById("dateLabel").textContent = "Original Target / Last Seen Date:";
            if (type === "posh") handleScenarioChange(); 
        } else {
            document.getElementById("ruleText").textContent = RULES[type].note;
            document.getElementById("dateLabel").textContent = (type === "posh") ? "Hospital Discharge Date:" : "Referral / Contact Date:";
        }
    }

    function addBusinessDays(date, days) {
        let result = new Date(date);
        let added = 0;
        while (added < days) {
            result.setDate(result.getDate() + 1);
            if (result.getDay() !== 0 && result.getDay() !== 6) added++;
        }
        return result;
    }

    function addCalendarDays(date, days) {
        let result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    }

    function revealStep4b() {
        document.getElementById("step4b_container").classList.remove("hidden");
        document.getElementById("step5_container").classList.remove("hidden");
        checkCompliance();
    }

    function calculateTarget() {
        const startStr = document.getElementById("startDate").value;
        const type = document.getElementById("apptType").value;
        const scenario = document.getElementById("callType").value;

        if (!startStr) { alert("Please select a date first."); return; }

        const parts = startStr.split('-');
        const startDate = new Date(parts[0], parts[1] - 1, parts[2]);
        
        const today = new Date();
        today.setHours(0,0,0,0);
        if (startDate > today && type !== "posh") {
            if (!confirm("‚ö†Ô∏è WARNING: Future date selected. Is this correct?")) return; 
        }

        const rule = RULES[type];
        let methodText = "";
        let originalTargetDate = null; 

        if (scenario === "cancel") {
            calculatedTargetDate = addBusinessDays(startDate, 10);
            originalTargetDate = new Date(calculatedTargetDate);
            methodText = "Calculated based on 10 Business Days from Original Target";
        } else {
            if (rule.bus > 0) {
                calculatedTargetDate = addBusinessDays(startDate, rule.bus);
                methodText = "Calculated based on " + rule.bus + " Business Days";
            } else {
                calculatedTargetDate = addCalendarDays(startDate, rule.cal);
                methodText = "Calculated based on " + rule.cal + " Calendar Days";
            }
            originalTargetDate = new Date(calculatedTargetDate);
        }

        const options = { weekday: 'short', year: 'numeric', month: 'long', day: 'numeric' };
        const resetEl = document.getElementById("resetNote");

        if (calculatedTargetDate < today) {
            calculatedTargetDate = today;
            resetEl.innerHTML = `‚ö†Ô∏è Original target <strong>(${originalTargetDate.toLocaleDateString('en-US')})</strong> passed.<br>Target reset to Today per 'Soonest Available' protocol.`;
            resetEl.classList.remove("hidden");
        } else {
            resetEl.classList.add("hidden");
        }

        document.getElementById("targetDateDisplay").textContent = calculatedTargetDate.toLocaleDateString('en-US', options);
        document.getElementById("calcMethod").textContent = methodText;
        document.getElementById("resultArea").style.display = "block";
        
        // Soft reset
        document.getElementById("offeredDate").value = "";
        document.getElementById("outcomeReason").selectedIndex = 0;
        document.getElementById("epnStatus").selectedIndex = 0;
        document.getElementById("step4b_container").classList.add("hidden");
        document.getElementById("step5_container").classList.add("hidden");
        document.getElementById("poolDisplay").classList.add("hidden");

        document.getElementById("finalStatus").textContent = "PENDING INPUT";
        document.getElementById("finalStatus").className = "status-fail"; 
        
        checkCompliance();
    }

    function updatePoolInfo(show = false) {
        const clinicKey = document.getElementById("homeClinic").value;
        const poolEl = document.getElementById("poolDisplay");
        
        if (!clinicKey || !show) {
            poolEl.classList.add("hidden");
            return;
        }

        const data = POOLS[clinicKey];
        document.getElementById("poolClinicName").textContent = data.name;
        document.getElementById("poolMgr").textContent = data.mgr;
        document.getElementById("poolClerk").textContent = data.clerk;
        poolEl.classList.remove("hidden");
    }

    function checkCompliance() {
        const offeredStr = document.getElementById("offeredDate").value;
        const epnStatus = document.getElementById("epnStatus").value;
        const outcomeReason = document.getElementById("outcomeReason").value;
        
        const statusEl = document.getElementById("finalStatus");
        const actionEl = document.getElementById("actionItem");
        const escalationEl = document.getElementById("escalationWarning");
        const warningEl = document.getElementById("dateWarning");

        escalationEl.classList.add("hidden");
        warningEl.classList.add("hidden");
        updatePoolInfo(false); // Hide pool info by default
        warningEl.textContent = "";

        // Check Internal Date
        let isInternalLate = false;
        let internalDateProvided = false;

        if (offeredStr && calculatedTargetDate) {
            internalDateProvided = true;
            const parts = offeredStr.split('-');
            const offeredDate = new Date(parts[0], parts[1] - 1, parts[2]);
            if (offeredDate > calculatedTargetDate) {
                isInternalLate = true;
            }
        }

        // --- COMPLIANCE LOGIC ---

        // 1. EPN ACCEPTED -> Compliant (Internal Late? Warn Only)
        if (epnStatus === "accepted") {
            if (isInternalLate) {
                statusEl.textContent = "‚úÖ COMPLIANT via EPN (Internal Target Missed)";
                statusEl.className = "status-warn";
                actionEl.textContent = "Access met via In-Network Provider. No escalation needed.";
                warningEl.textContent = "Note: Internal appointment was unavailable/late, but EPN saved compliance.";
                warningEl.classList.remove("hidden");
            } else {
                statusEl.textContent = "‚úÖ COMPLIANT (EPN Accepted)";
                statusEl.className = "status-pass";
                actionEl.textContent = "Patient accepted In-Network care. Access standard met.";
            }
            return;
        }

        // 2. INTERNAL CHECK
        if (internalDateProvided) {
            // A. Good Date
            if (!isInternalLate) {
                statusEl.textContent = "‚úÖ COMPLIANT (Target Met)";
                statusEl.className = "status-pass";
                actionEl.textContent = "Internal appointment offered within timeframe.";
                return;
            }

            // B. Late Date + Patient Declined Earlier
            if (outcomeReason === "patient_declined") {
                statusEl.textContent = "‚úÖ COMPLIANT (Member Declined)";
                statusEl.className = "status-pass";
                actionEl.textContent = "Access met, but member chose later date. Document 'RLD'.";
                return;
            }

            // C. FAIL STATE (Late Date + Provider Unavailable)
            statusEl.textContent = "‚ùå NON-COMPLIANT (Access Missed)";
            statusEl.className = "status-fail";
            escalationEl.classList.remove("hidden");
            
            // Show Routing Info automatically if failed
            updatePoolInfo(true);
            
            if (epnStatus === "declined") {
                actionEl.textContent = "Member declined In-Network option & no internal appt available.";
            } else {
                actionEl.textContent = "No appointments available.";
            }
        } else {
            statusEl.textContent = "PENDING INPUT";
            statusEl.className = "status-fail";
            actionEl.textContent = "Please enter the offered date.";
        }
    }
</script>

</body>
</html>
